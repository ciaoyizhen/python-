# 第十五章 假设检验

有些人看起来是好人，实际是坏人；有些人看起来是坏人，实际是好人。好人还是坏人，不但与他实际是好人还是坏人有关，还与我们的眼睛有关。所谓“甲之蜜糖，乙之砒霜也”，判断一个事物的好坏，不但和我们的判断标准有关，还和判断方法有关。

## 假设检验概述

### 初识假设检验

假设检验是数理统计学中根据一定假设条件由样本推断总体的一种方法。事先对总体参数或分布形式做出某种假设，然后利用样本信息来判断原假设是否成立，采用逻辑上的反证法，依据统计上的小概率原理得出结论。所谓就是如果要证明一个结论是正确的，那么就先假设这个结论是错误的，然后以这个结论是错误的为前提条件进行推理，推理出来的结果与假设条件矛盾，这个时候就说明这个假设是错误的，也就是这个结论是正确的。

下面举一个实际例子——女士品茶来说明。

有位女士一次喝茶时提出了一个有趣的观点：把茶加到奶里和奶加到茶里，最后得到的奶茶的味道是不一样的。大部分都觉得这位女士是在瞎说，但是Fisher教授提出了要用科学的方法去证明到底一样还是不一样（牛人就是牛人，所以我们遇到问题要多想想为什么别人那么说，而不是不经思考就拒绝）。接下来我们看一下试验方法：他调配出了8杯其他条件一模一样而仅仅是倒茶、倒奶顺序相反的茶，其中每类各4杯。然后他让女士品尝之后告诉他哪四杯是先加奶的，剩下的就都是先加茶的了。

事实上，Fisher运用了这样的逻辑：首先假设女士没有这个能力（这个假设被称为原假设或空假设），如果女士很准确的鉴别了这8杯茶，那就说明在原假设成立的情况下，发生了非常反常的现象（小概率事件），以至于说明原假设是令人怀疑的。



### 假设检验的步骤

#### 提出空假设或备择假设

空假设（$H_0$）一般是要推翻的论点，备择假设($H_1$)则是要证明的论点。以上述女士品茶为例

+ $H_0$：把茶加到奶里和把奶加到茶里得到的奶茶是一样的。
+ $H_1$：把茶加到奶里和把奶加到查理得到的奶茶是不一样的。

#### 构造检验统计量

检验统计量是根据样本观测结果计算得到的样本统计量，并以此对空假设和备择假设作出决策。具体而言，假设总体$X\sim N$，$X_1,X_2, ...,X_n$为取自该总体$X$的样本，n为样本总量，$\bar{X}$为样本均值，$S^2$为样本方差。那么有：
$$
统计量U=\frac{\bar{X}-\mu}{\sigma}\sqrt{n}\sim N(0, 1)\\
统计量T=\frac{\bar{X}-\mu}{S}\sqrt{n}\sim t(n-1) \\
统计量\chi^2=\frac{(n-1)S^2}{\sigma}\sqrt{n}\sim \chi^2(0, 1)
$$
这3种统计量及其对应分布分别为z检验(z-test)、t检验(t-test)和卡方检验。

+ z检验一般用于大样本(即样本容量大于30)平均值差异性检验。它是用标准正态分布的理论来推断差异发生的概率，而从此比较两个平均数的差异是否显著。
+ t检验主要是用于样本含量较小(如n<30)，总体标准差$\sigma$未知的正态分布。t检验是用t分布理论来推论差异发生的概率，从而比较两个平均数的差异是否显著。
+ 卡方检验是统计样本的实际观测值与理论推断值之间的偏离程度，实际观测值和理论推断值之间的偏离程度决定了卡方值的大小。卡方值越大，二者偏离就越大；反之，二者偏差越小；若两个值完全相等时，卡方值为0，表面理论值完全符合。

整体可以看下面这张图

![93c249b9a431203910cb9ca2536b2b8](D:\webdownload\93c249b9a431203910cb9ca2536b2b8.jpg)

#### 根据要求的显著性水平求临界值和拒绝域

如果小概率事件发生了，就表示空假设是错误的，可是具体多小的概率才算是小概率呢？一般这个概率为0.05，也就是5%，如果一件事情发生的概率小于或等于5%，我们就认为这是一个小概率事件，0.05就是显著性水平，用$\alpha$表示。显著性水平把概率分布分为两个区间：拒绝区间和接受区间。最后计算的结果落在拒绝区间，就可以拒绝空假设；如果落在接受区间，就需要接受空假设，$1-\alpha$为置信水平(置信度)。

#### 计算检验统计量

根据前面选择的检验统计量类型，计算对应的检验统计量的值。除此之外，我们还可以根据样本量得出p值，p值就是实际样本中小概率事件的具体概率值。

#### 决策

比较计算出来的检验统计量与临界值和拒绝域，如果值落在了拒绝域内，那就要拒绝空假设，否则接受空假设。比较计算出来的p值和显著性水平$\alpha$值，如果$p\le\alpha$，则拒绝空假设，否则接受空假设。





### 假设检验中的Ⅰ类错误和Ⅱ类错误

前面探讨了假设检验的基本思想，这里介绍假设检验中的两类错误。

假设检验的目的是去伪存真，那么它对应的两类错误就是弃真存伪。

第一类错误就叫做弃真错误，通俗一点就是漏诊，就是本来生病了(假设是正确的)，但是没有检测出来，所以就给拒绝掉了。

第二类错误就叫做存伪错误，通俗一点就是误诊，本来没病，结果诊断说有病。



举个例子：

+ $H_0$：没有怀孕。
+ $H_1$：怀孕了
+ 第一类错误就是没有怀孕被你说成怀孕了，第二类错误就是怀孕了被你说成没怀孕。



## python的假设检验

### 单样本t-test

单样本t-test属于参数检验，用于比较样本数据与一个特定数值之间的差异情况。例如，想比较成都的工资水平与全国工资水平是否存在显著差异。

```python
# 构造全国工资水平
population_salary1 = stats.poisson.rvs(loc=1300, mu=3500, size=150000)
population_salary2 = stats.poisson.rvs(loc=1300, mu=2000, size=100000)
population = np.concatenate((population_salary1, population_salary2))

# 对构造成都工资水平
cd_salary1 = stats.poisson.rvs(loc=1300, mu=3200, size=30)
cd_salary2 = stats.poisson.rvs(loc=1300, mu=1700, size=20)
cd_salary = np.concatenate((cd_salary1, cd_salary2))
# 显示两个的均值
print(population.mean())
print(cd_salary.mean())
```

这里我们可以看到，两个工资的均值是不同的，现在我们想要知道二者有无显著差异，就可以用stats模块的ttest_lsampe()函数进行假设检验。

```python
stats.ttest_1samp(a=cd_salary, popmean=population.mean())
# 这里结果p=0.007，显然应该拒绝原假设，认为两个工资有显著差异
```

此外，还可以利用stats.t.ppf()函数进行验证。

```
stats.t.ppf(q=0.025, df=49)
stats.t.ppf(q=0.975, df=49)
```

显然t值在95%的置信区间以外。还可以通过t.interval()函数进行验证。

```python
sigma = cd_salary.std()/np.sqrt(50)
stats.t.interval(0.95, df=49, loc=cd_salary.mean(), scale=sigma)
# 这个返回置信区间
```

#### 双样本t-test

双样本t-test是根据样本数据对两个样本来自的两个独立总体的均值是否有显著差异进行判断。它需要满足下以下3个条件：

+ 随机抽样，所有观测应该随机地从目标总体中抽出。
+ 正态分布，每个样本来自的总体必须满足正态分布。
+ 方差齐性，均值比较时，要求两总体方差相等。

还是以工资数据为例，先构造一个重庆工资数据样本

```python
cq_salary1 = stats.poisson.rvs(loc=1300, mu=3100, size=30)
cq_salary2 = stats.poisson.rvs(loc=1300, mu=1100, size=20)
cq_salary = np.concatenate((cq_salary1, cq_salary2))
cq_salary.mean()
```

双样本检验使用的函数为ttest_ind()函数

```python
stats.ttest_ind(a=cd_salary, b=cq_salary)
```

输出结果为0.07，如果显著性水平为0.05，那么此时是无法拒绝原假设的。但实际上也就是说有7%的可能看到成都和重庆的工资数据有这样的差异。

#### 配对t-test

配对t-test在医疗行业应用广泛，例如在医疗试验中：配对的两个受试对象分别接受两种不同的处理；同一受试对象处理前后的结果进行比较（自身配对）；同一对象的两个部位给予不同的处理。

下面选择某种减肥药的试验为例进行说明：

先随机生成样本

```python
before = stats.norm.rvs(scale=10, loc=60, size=100)
after = before + stats.norm.rvs(scale=5, loc=-1.25, size=100)
weight_df = pd.DataFrame({'weight_before': before,
                           'weight_after': after})
weight_df.sample(5)

weight_df.describe()  # 事实上，我们可以通过describe命令输出一系列指标
```

配对检验的函数使用ttest_rel()函数

```python
stats.ttest_rel(a=before, b=after)
```

#### 卡方检验

卡方检验属于非参数检验的范畴，主要是比较两个及两个以上样本率（构成比）以及两个分类变量的关联性分析。其根本思想就是比较理论频数和实际频数的吻合成都或拟合优度问题。上面的描述非常晦涩难懂，这里用几个简单的卡方检验例子来说明。

+ 男性和女性的线上生鲜食品购买习惯有无差别？
+ 不吃早饭对体重下降有无影响？
+ 疗效是否与不同药品有关？
+ 不同广告渠道获得的用户，次日留存率是否有差别？

以上问题都可以利用卡方检验来回答，这里以最后一个问题为例说明卡方检验的应用。

假设某移动应用推广使用了3个不同渠道，分别是门户网站的在线广告、微信推广、微博推广。现在想判断以上3个不同渠道获得的用户的留存率是否有差别。

这个数据中是每天应用的新注册人数和次日继续使用用户数。

```python
file = r'../data/reguser.txt'
data = pd.read_csv(file, sep='\t')
data.head()
```

构造流失人数，并根据注册类型进行比较

```python
data['lost'] = data['reg'] - data['stay']
data.head()
observed = data.groupby('type').sum()
observed.head()
```

现在想知道来自不同渠道的用户的次日留存是否相互独立，利用卡方检验

```python
stats.chi2_contingency(observed=observed[['stay', 'lost']])
# 第一个返回的是卡方值，第二个为p值，第三个为自由度，第四个为置信区间
```

从p值可以看到，是小于0.05的，因此拒绝原假设，认为用户的渠道类别影响了次日留存情况。

计算留存率

```python
observed['stay']/observed['reg']
```

